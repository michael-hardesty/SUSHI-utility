<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SUSHI Data Harvester</title>
  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      const WORKER_URL = 'https://sushi-harvester.mhardesty.workers.dev';
      const form = document.getElementById('harvestForm');
      const resultsContent = document.getElementById('resultsContent');
      const resultsDiv = document.getElementById('results');
      const progress = document.getElementById('progress');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        resultsDiv.style.display = 'none';
        progress.textContent = 'Submitting...';

        try {
          const accountsText = document.getElementById('accounts').value.trim();
          const [begin, end] = [document.getElementById('beginDate').value, document.getElementById('endDate').value];
          const format = document.getElementById('format').value;
          const reportType = document.getElementById('reportType').value;

          const accounts = accountsText.split('\n').map(line => {
            const [requestor_id, customer_id] = line.split(',').map(v => v.trim());
            return { requestor_id, customer_id };
          }).filter(a => a.requestor_id && a.customer_id);

          const payload = { accounts, begin_date: begin, end_date: end, format, report_type: reportType };
          const res = await fetch(`${WORKER_URL}/harvest-batch`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
          });

          const result = await res.json();
          console.log("Server result:", result);
          resultsDiv.style.display = 'block';

          if (!result.csv) {
            throw new Error("No CSV returned from server. Response: " + JSON.stringify(result));
          }

          const blob = new Blob([result.csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);

          resultsContent.innerHTML = `
            <h3>‚úÖ Harvest Complete!</h3>
            <p>Processed ${result.successful} out of ${result.total} accounts</p>
            <p><strong>Usage:</strong> ${result.summary.totalUsage}</p>
            <p><strong>Platforms:</strong> ${result.summary.uniquePlatforms}</p>
            <p><strong>Metric Types:</strong> ${result.summary.metricTypes.join(', ')}</p>
            <a href="${url}" download="harvest.csv">üì• Download CSV</a>
          `;
        } catch (err) {
          console.error("Frontend error:", err);
          resultsDiv.style.display = 'block';
          resultsContent.innerHTML = `<h3>‚ùå Error</h3><pre>${err.message}</pre>`;
        }
      });
    });
  </script>
</head>
<body>
  <h1>SUSHI Data Harvester</h1>
  <form id="harvestForm">
    <label>Report Format: <select id="format"><option value="5">5</option><option value="5.1">5.1</option></select></label><br/>
    <label>Report Type: <select id="reportType">
      <option value="tr_j1">TR_J1</option><option value="tr_j2">TR_J2</option>
    </select></label><br/>
    <label>Begin Date: <input type="date" id="beginDate" required /></label>
    <label>End Date: <input type="date" id="endDate" required /></label><br/>
    <label>Accounts:<br/><textarea id="accounts" rows="5" cols="60" placeholder="email@domain,customer_id"></textarea></label><br/>
    <button type="submit">Submit</button>
  </form>
  <div id="progress"></div>
  <div id="results" style="display:none;"><div id="resultsContent"></div></div>
</body>
</html>
